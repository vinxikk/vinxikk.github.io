<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Hive的管理表和外部表&amp;分区表&amp;分桶表&amp;行转列和列转行"><meta name="keywords" content="管理表和外部表,分区表,分桶表,行列互转"><meta name="author" content="VinxC"><meta name="copyright" content="VinxC"><title>Hive的管理表和外部表&amp;分区表&amp;分桶表&amp;行转列和列转行 | VinxC's blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建表"><span class="toc-number">1.</span> <span class="toc-text">创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内部表和外部表"><span class="toc-number">2.</span> <span class="toc-text">内部表和外部表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#管理表"><span class="toc-number">2.1.</span> <span class="toc-text">管理表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#外部表"><span class="toc-number">2.2.</span> <span class="toc-text">外部表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分区表"><span class="toc-number">3.</span> <span class="toc-text">分区表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本用法"><span class="toc-number">3.1.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多级分区表"><span class="toc-number">3.2.</span> <span class="toc-text">多级分区表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据关联和修复"><span class="toc-number">3.3.</span> <span class="toc-text">数据关联和修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#静态分区和动态分区"><span class="toc-number">4.</span> <span class="toc-text">静态分区和动态分区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#静态分区"><span class="toc-number">4.1.</span> <span class="toc-text">静态分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态分区"><span class="toc-number">4.2.</span> <span class="toc-text">动态分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">4.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分桶表"><span class="toc-number">5.</span> <span class="toc-text">分桶表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建分桶表，并导入本地数据"><span class="toc-number">5.1.</span> <span class="toc-text">创建分桶表，并导入本地数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建分桶表，并通过子查询的方式导入数据"><span class="toc-number">5.2.</span> <span class="toc-text">创建分桶表，并通过子查询的方式导入数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分桶抽样查询"><span class="toc-number">5.3.</span> <span class="toc-text">分桶抽样查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据块抽样"><span class="toc-number">5.4.</span> <span class="toc-text">数据块抽样</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#行转列和列转行"><span class="toc-number">6.</span> <span class="toc-text">行转列和列转行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#行转列"><span class="toc-number">6.1.</span> <span class="toc-text">行转列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#列转行"><span class="toc-number">6.2.</span> <span class="toc-text">列转行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#关键函数释义"><span class="toc-number">6.3.</span> <span class="toc-text">关键函数释义</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://vinxikk.github.io/img/avatar.png"></div><div class="author-info__name text-center">VinxC</div><div class="author-info__description text-center">A Bigdata Developer</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">47</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">77</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">12</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com" target="_blank" rel="noopener">Molunerfinn</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">VinxC's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Hive的管理表和外部表&amp;分区表&amp;分桶表&amp;行转列和列转行</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-04-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Hive/">Hive</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.1k</span><span class="post-meta__separator">|</span><span>Reading time: 16 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><p>建表语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">EXTERNAL</span>] <span class="keyword">TABLE</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] table_name </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[(col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)] </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">COMMENT</span> table_comment] </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">[PARTITIONED <span class="keyword">BY</span> (col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)] </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">[CLUSTERED <span class="keyword">BY</span> (col_name, col_name, ...) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">[SORTED <span class="keyword">BY</span> (col_name [<span class="keyword">ASC</span>|<span class="keyword">DESC</span>], ...)] <span class="keyword">INTO</span> num_buckets BUCKETS] </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">ROW</span> <span class="keyword">FORMAT</span> row_format] </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">STORED</span> <span class="keyword">AS</span> file_format] </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">[LOCATION hdfs_path]</span></pre></td></tr></table></figure>

<p>字段说明：</p>
<ol>
<li><p>CREATE TABLE创建一个指定名字的表，如果表已经存在，则抛出异常；用户可以用IF NOT EXISTS选项来忽略这个异常。</p>
</li>
<li><p>EXTERNAL关键字可以创建一个外部表，在建表的同时指定一个指向实际数据的路径（LOCATION）。Hive创建内部表时，会将数据移动到数据仓库指向的路径；若创建外部表，仅记录数据所在的路径，不对数据的位置做任何改变。在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。</p>
</li>
<li><p>COMMENT: 为表和列添加注释。</p>
</li>
<li><p>PARTITIONED BY: 创建分区表</p>
</li>
<li><p>CLUSTERED BY: 创建分桶表</p>
</li>
<li><p>ROW FORMAT</p>
<p>DELIMITED [FIELDS TERMINATED BY char] [COLLECTION ITEMS TERMINATED BY char] [MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char] | SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, …)]</p>
<p>用户在建表的时候可以自定义SerDe或者使用自带的SerDe，如果没有指定ROW FORMAT或者ROW FORMAT DELIMITED，将会使用自带的SerDe。建表时用户还需要为表指定列，用户在指定表的列的同时也会指定自定义的SerDe，Hive通过SerDe确定表的具体的列的数据。</p>
</li>
<li><p>STORED AS: 指定存储文件类型</p>
<p>常用的存储文件类型：SEQUENCEFILE（二进制序列文件）、TEXTFILE（文本）、RCFILE（列式存储格式文件）。</p>
<p>如果文件数据是纯文本，可以使用STORED AS TEXTFILE。如果数据需要压缩，使用 STORED AS SEQUENCEFILE。</p>
</li>
<li><p>LOCATION: 指定表在HDFS上的存储位置。</p>
</li>
<li><p>LIKE允许用户复制现有的表结构，但是不复制数据。</p>
</li>
</ol>
<h3 id="内部表和外部表"><a href="#内部表和外部表" class="headerlink" title="内部表和外部表"></a>内部表和外部表</h3><p>内部表（管理表）：删除表时，元数据（META）删除，业务数据（HDFS）也删除。</p>
<p>外部表：删除表时，元数据删除，HDFS中业务数据不删除。</p>
<p>管理表和外部表的使用场景：</p>
<p>每天将收集到的网站日志定期流入HDFS文本文件，在外部表（原始日志表）的基础上做大量的统计分析，用到的中间表、结果表使用内部表存储，数据通过SELECT+INSERT进入内部表。</p>
<h4 id="管理表"><a href="#管理表" class="headerlink" title="管理表"></a>管理表</h4><p>默认创建的表都是所谓的管理表，也被称为内部表，因为这种表，Hive会（或多或少）控制着数据的生命周期。Hive默认情况下会将这些表的数据存储在<code>hive.metastore.warehouse.dir</code>(例如，/user/hive/warehouse)所定义的目录的子目录下。当我们删除一个管理表时，Hive也会删除这个表中的数据。管理表不适合和其他工具共享数据。</p>
<p>创建管理表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">empno <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">ename <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">job <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">mgr <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">hiredate <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">sal <span class="keyword">double</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">comm <span class="keyword">double</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">deptno <span class="built_in">int</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">) <span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>加载数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 从Linux本地加载</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/data/emp.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> emp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 从HDFS加载</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> inpath <span class="string">'/data/emp.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> emp;</span></pre></td></tr></table></figure>

<p>查看表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 简单查看</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">desc emp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式化查看详细信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">desc formatted emp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">Table Type:             MANAGED_TABLE</span></pre></td></tr></table></figure>

<h4 id="外部表"><a href="#外部表" class="headerlink" title="外部表"></a>外部表</h4><p>因为是外部表，所以Hive并非认为其完全拥有这份数据。删除该表并不会删除掉这份数据，不过描述表的元数据信息会被删除掉。</p>
<p>创建外部表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建外部表，并指定在HDFS中存储的路径</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> emp_external(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">empno <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">ename <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">job <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">mgr <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">hiredate <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">sal <span class="keyword">double</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">comm <span class="keyword">double</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">deptno <span class="built_in">int</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">location <span class="string">'/hive_data/hive_external_table/emp/'</span>;</span></pre></td></tr></table></figure>

<p>使用HDFS命令加载表数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">hdfs dfs -put emp.txt /hive_data/hive_external_table/emp/</span></pre></td></tr></table></figure>

<p>查看创建的表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">hive (default)&gt; show tables;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">OK</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">tab_name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">emp</span></pre></td></tr></table></figure>

<p>查询表数据：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select * from emp;</span></pre></td></tr></table></figure>

<p>查看格式化表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">hive (default)&gt; desc formatted dept;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Table Type:             EXTERNAL_TABLE</span></pre></td></tr></table></figure>

<h3 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h3><p>引入分区表（需要根据日期对日志进行管理）：</p>
<p><code>/user/hive/warehouse/log_partition/20180402/20180402.log</code></p>
<p><code>/user/hive/warehouse/log_partition/20180403/20180403.log</code></p>
<p><code>/user/hive/warehouse/log_partition/20180404/20180404.log</code></p>
<h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><p>创建分区表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_partition(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">lid <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">lrecord <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">ltime <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">month</span> <span class="keyword">string</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>加载数据到分区表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/logs/log.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> log_partition <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201804'</span>);</span></pre></td></tr></table></figure>

<p>查询分区表中的数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单分区查询</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> log_partition <span class="keyword">where</span> <span class="keyword">month</span>=<span class="string">'201804'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 多分区查询</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> log_partition <span class="keyword">where</span> <span class="keyword">month</span>=<span class="string">'201803'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> log_partition <span class="keyword">where</span> <span class="keyword">month</span>=<span class="string">'201804'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> log_partition <span class="keyword">where</span> <span class="keyword">month</span>=<span class="string">'201805'</span></span></pre></td></tr></table></figure>

<p>增加分区：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建单个分区</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> log_partiton <span class="keyword">add</span> <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201806'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建多个分区</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> log_partition <span class="keyword">add</span> <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201806'</span>) <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201807'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 增加多个分区之间用空格" "隔开，删除多个分区用","隔开</span></span></pre></td></tr></table></figure>

<p>删除分区：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除单个分区</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> log_partition <span class="keyword">drop</span> <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201804'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除多个分区</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> log_partition <span class="keyword">drop</span> <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201803'</span>),<span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201805'</span>);</span></pre></td></tr></table></figure>

<p>查看分区表有多少分区：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">partitions</span> log_partition;</span></pre></td></tr></table></figure>

<p>查看分区表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">desc formatted log_partition;</span></pre></td></tr></table></figure>

<h4 id="多级分区表"><a href="#多级分区表" class="headerlink" title="多级分区表"></a>多级分区表</h4><p>创建二级分区表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_partition2(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">lid <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">lrecord <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">ltime <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">month</span> <span class="keyword">string</span>, <span class="keyword">day</span> <span class="keyword">string</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>加载数据到二级分区表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/logs/log.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> log_partition2 <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201804'</span>, <span class="keyword">day</span>=<span class="string">'13'</span>);</span></pre></td></tr></table></figure>

<p>查询分区数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> log_partition2 <span class="keyword">where</span> <span class="keyword">month</span>=<span class="string">'201804'</span> <span class="keyword">and</span> <span class="keyword">day</span>=<span class="string">'13'</span>;</span></pre></td></tr></table></figure>

<h4 id="数据关联和修复"><a href="#数据关联和修复" class="headerlink" title="数据关联和修复"></a>数据关联和修复</h4><p>把数据上传到分区目录上，让分区表和数据产生关联的三种方式：</p>
<ol>
<li><p>上传数据后修复</p>
<p>上传数据：</p>
<p>hive (hive_2)&gt; <code>dfs -mkdir -p /user/hive/warehouse/log_partition2/month=201804/day=13;</code></p>
<p>hive (hive_2)&gt; <code>dfs -put /home/vinx/logs/log.txt /user/hive/warehouse/log_partition2/month=201804/day=13;</code></p>
<p>查询数据（查询不到刚才上传的数据）：</p>
<p>hive (hive_2)&gt; <code>select * from log_partition2 where month=&#39;201804&#39; and day=&#39;13&#39;;</code></p>
<p>执行修复命令：</p>
<p>hive (hive_2)&gt; <code>msck repair table log_partition2;</code></p>
<p>再次查询数据：</p>
<p>hive (hive_2)&gt; <code>select * from log_partition2 where month=&#39;201804&#39; and day=&#39;13&#39;;</code></p>
</li>
<li><p>上传数据后添加分区</p>
<p>上传数据：</p>
<p>hive (hive_2)&gt; <code>dfs -mkdir -p /user/hive/warehouse/log_partition2/month=201804/day=14;</code></p>
<p>hive (hive_2)&gt; <code>dfs -put /home/vinx/logs/log.txt /user/hive/warehouse/log_partition2/month=201804/day=14;</code></p>
<p>添加分区：</p>
<p>hive (hive_2)&gt; <code>alter table log_partition2 add partition(month=&#39;201804&#39;, day=&#39;14&#39;);</code></p>
<p>查询数据：</p>
<p>hive (hive_2)&gt; <code>select * from log_partition2 where month=&#39;201804&#39; and day=&#39;14&#39;;</code></p>
</li>
<li><p>上传数据后load数据到分区：</p>
<p>创建目录：</p>
<p>hive (hive_2)&gt; <code>dfs -mkdir -p /user/hive/warehouse/log_partition2/month=201804/day=15;</code></p>
<p>上传数据：</p>
<p>hive (hive_2)&gt; <code>load data local inpath &#39;/home/vinx/logs/log.txt&#39; into table log_partition2 partition(month=&#39;201804&#39;,day=&#39;15&#39;);</code></p>
<p>查询数据：</p>
<p>hive (hive_2)&gt; <code>select * from log_partition2 where month=&#39;201804&#39; and day=&#39;15&#39;;</code></p>
</li>
</ol>
<h3 id="静态分区和动态分区"><a href="#静态分区和动态分区" class="headerlink" title="静态分区和动态分区"></a>静态分区和动态分区</h3><p>分区是Hive存放数据的一种形式，查询数据时使用分区列进行过滤，只需根据列值直接扫描对应目录下的数据。</p>
<p>Hive的一个分区名对应一个目录名，子分区名就是子目录名，并不是一个实际的字段。</p>
<p>插入数据的时候指定分区，其实就是新建一个目录或者子目录，或者在原有的目录上添加数据文件。</p>
<h4 id="静态分区"><a href="#静态分区" class="headerlink" title="静态分区"></a>静态分区</h4><p>若分区的值是确定的，那么称为静态分区。新增分区或者是加载分区数据时，已经指定分区名。</p>
<p>创建静态分区表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> order_partition(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    order_number <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    event_time <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">partitioned <span class="keyword">by</span> (event_month <span class="keyword">string</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>加载数据到分区表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法1：通过load方式加载</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/data/order.txt'</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> order_partition (event_month=<span class="string">'2017-09'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法2：查询并导入</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> order_partition <span class="keyword">partition</span>(event_month=<span class="string">'2017-09'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> order_number,event_time <span class="keyword">from</span> order_partition <span class="keyword">where</span> event_month=<span class="string">'2017-08'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法3：手动创建HDFS文件夹，并上传文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 静态分区表如果手动创建对应的HDFS目录，并上传文件，分区表中无法查到该分区信息，则需要刷新修复</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> order_partition <span class="keyword">where</span> event_month=<span class="string">'2017-09'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 此时是查询不到分区数据的，需要修复表信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">msck <span class="keyword">repair</span> <span class="keyword">table</span> order_partiton;</span></pre></td></tr></table></figure>

<p>查询指定分区数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> order_partiton <span class="keyword">where</span> event_month=<span class="string">'2017-09'</span>;</span></pre></td></tr></table></figure>

<h4 id="动态分区"><a href="#动态分区" class="headerlink" title="动态分区"></a>动态分区</h4><p>动态分区指不需要为不同的分区添加不同的插入语句，分区不确定，需要从数据中获取。</p>
<p>参数设置：</p>
<ol>
<li><p>开启动态分区功能（默认true，开启）</p>
<p><code>set hive.exec.dynamic.partition=true</code></p>
</li>
<li><p>设置为非严格模式（默认strict，表示必须指定至少一个分区为静态分区，nonstrict表示允许所有的分区字段都可以使用动态分区）</p>
<p><code>set hive.exec.dynamic.partiton.mode=nonstrict</code></p>
</li>
<li><p>在所有执行MR的节点上，最大一共可以创建多少个动态分区（默认1000）</p>
<p><code>set hive.exec.max.dynamic.partitions=1000</code></p>
</li>
<li><p>在每个执行MR的节点上，最大可以创建多少个动态分区。该参数需要根据实际的数据来设定。比如：源数据中包含了一年的数据，即day字段有365个值，那么该参数就需要设置成大于365，如果使用默认值100，则会报错</p>
<p><code>set hive.exec.max.dynamic.partitions.pernode=100</code></p>
</li>
<li><p>整个MR job中，最大可以创建多少个HDFS文件（默认值100000）</p>
<p><code>set hive.exec.max.created.files=100000</code></p>
</li>
<li><p>当有空分区生成时，是否抛出异常（默认false，一般不需要设置）</p>
<p><code>set hive.error.on.empty.partition=false</code></p>
</li>
</ol>
<p>案例需求：</p>
<p>将ori中的数据按照时间(如：20111230000008)，插入到目标表ori_partition_target的相应分区中。</p>
<p>创建分区表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ori_partition(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">id</span> <span class="built_in">bigint</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">time</span> <span class="built_in">bigint</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    uid <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    keyword <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    url_rank <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    click_num <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    click_url <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">partitioned <span class="keyword">by</span> (p_time <span class="built_in">bigint</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>加载数据到分区表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/datas/ds1'</span> <span class="keyword">into</span> <span class="keyword">table</span> ori_partition <span class="keyword">partition</span>(p_time=<span class="string">'20111230000010'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/datas/ds2'</span> <span class="keyword">into</span> <span class="keyword">table</span> ori_partition <span class="keyword">partition</span>(p_time=<span class="string">'20111230000011'</span>);</span></pre></td></tr></table></figure>

<p>创建目标分区表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ori_partition_target(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">id</span> <span class="built_in">bigint</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">time</span> <span class="built_in">bigint</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    uid <span class="keyword">string</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    keyword <span class="keyword">string</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    url_rank <span class="built_in">int</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    click_num <span class="built_in">int</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    click_url <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">partitioned <span class="keyword">by</span> (p_time <span class="keyword">string</span>) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>设置动态分区：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition = <span class="literal">true</span>;<span class="comment">-- （默认true）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition.mode = nonstrict;<span class="comment">-- (默认strict)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.max.dynamic.partitions = <span class="number">1000</span>;<span class="comment">-- (默认1000)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.max.dynamic.partitions.pernode = <span class="number">100</span>;<span class="comment">-- （默认100）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.max.created.files = <span class="number">100000</span>;<span class="comment">-- (默认值100000)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.error.on.empty.partition = <span class="literal">false</span>;<span class="comment">-- (默认值false)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> ori_partition_target partitoin(p_time) <span class="keyword">select</span> <span class="keyword">id</span>,<span class="built_in">time</span>,uid,keyword,url_rank,click_num,click_url,p_time <span class="keyword">from</span> ori_partition;</span></pre></td></tr></table></figure>

<p>查看目标分区表的分区情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">partitions</span> ori_partition_target;</span></pre></td></tr></table></figure>

<p>如果不设置为非严格模式，报错如下：</p>
<p>FAILED: SemanticException [Error<br>10096]: Dynamic partition strict mode requires at least one static partition<br>column. To turn this off set hive.exec.dynamic.partition.mode=nonstrict.</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>尽量不要使用动态分区，因为动态分区的时候，将会为每一个分区分配reducer，当分区数量多的时候，reducer数量将会相应增加。</p>
<p>静态分区不管有没有数据都会创建该分区，动态分区是有结果集就创建，否则不创建。</p>
<p>hive.mapred.mode=strict 为了阻止用户不小心提交恶意HQL</p>
<p>如果设置为strict，将会阻止以下3种查询：</p>
<ol>
<li>对分区表查询，where中过滤字段不是分区字段</li>
<li>笛卡尔积join查询，不带on或where的join查询语句</li>
<li>order by查询不带limit条件</li>
</ol>
<h3 id="分桶表"><a href="#分桶表" class="headerlink" title="分桶表"></a>分桶表</h3><p>分区针对的是数据的存储路径，分桶针对的是数据文件。</p>
<p>分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区。分桶是将数据集分解成更容易管理的若干部分的一个技术。</p>
<p>Hive分桶就是将表（或者分区，即HDFS存储在该目录下的真正数据）中文件分成几个文件去存储。在处理大规模数据集时，在开发阶段，如果能在数据集的一小部分数据上试运行查询，会带来很多方便。</p>
<h4 id="创建分桶表，并导入本地数据"><a href="#创建分桶表，并导入本地数据" class="headerlink" title="创建分桶表，并导入本地数据"></a>创建分桶表，并导入本地数据</h4><p>创建分桶表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu_bucket(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">name</span> <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">clustered <span class="keyword">by</span>(<span class="keyword">id</span>) <span class="keyword">into</span> <span class="number">4</span> buckets</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>查看表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">desc formatted stu_bucket;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Num Buckets:            4</span></pre></td></tr></table></figure>

<p>导入数据到分桶表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/data/student.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> stu_bucket;</span></pre></td></tr></table></figure>

<p>此时会发现并没有分成4个桶</p>
<h4 id="创建分桶表，并通过子查询的方式导入数据"><a href="#创建分桶表，并通过子查询的方式导入数据" class="headerlink" title="创建分桶表，并通过子查询的方式导入数据"></a>创建分桶表，并通过子查询的方式导入数据</h4><p>创建一个普通的stu表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">name</span> <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr></table></figure>

<p>向stu表中导入数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/data/student.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> stu;</span></pre></td></tr></table></figure>

<p>清空stu_bucket表中数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> stu_bucket;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> stu_bucket;</span></pre></td></tr></table></figure>

<p>导入数据到分桶表，通过子查询的方式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> stu_buck <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> stu;</span></pre></td></tr></table></figure>

<p>设置属性：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.enforce.bucketing=<span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=<span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> stu_bucket <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> stu;</span></pre></td></tr></table></figure>

<p>查询分桶的数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> stu_bucket;</span></pre></td></tr></table></figure>

<h4 id="分桶抽样查询"><a href="#分桶抽样查询" class="headerlink" title="分桶抽样查询"></a>分桶抽样查询</h4><p>对于非常大的数据集，有时需要使用的是一个具有代表性的查询结果而不是全部结果，Hive可以通过对表进行抽样来满足这个需求。</p>
<p>查询stu_bucket中的数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> stu_bucket <span class="keyword">tablesample</span>(<span class="keyword">bucket</span> <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">4</span> <span class="keyword">on</span> <span class="keyword">id</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- tablesample是抽样语句，语法：tablesample(bucket x out of y)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 不是桶数的倍数或者因子也可以，但是不推荐</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> stu_bucket <span class="keyword">tablesample</span>(<span class="keyword">bucket</span> <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">3</span> <span class="keyword">on</span> <span class="keyword">id</span>);</span></pre></td></tr></table></figure>

<p>y必须是table总bucket数的倍数或者因子。hive根据y的大小，决定抽样的比例。例如，table总共分了4份，当y=2时，抽取（4/2=）2个bucket的数据，当y=8时，抽取（4/8=）1/2个bucket的数据。</p>
<p>x表示从哪个bucket开始抽取。例如，table总bucket数为4，tablesample(bucket 4 out of 4)，表示总共抽取（4/4=）1个bucket的数据，抽取第4个bucket的数据。</p>
<p>注意：x的值必须小于等于y的值，否则：</p>
<p>FAILED: SemanticException [Error 10061]: Numerator should not be bigger than denominator in sample clause for table stu_bucket.</p>
<h4 id="数据块抽样"><a href="#数据块抽样" class="headerlink" title="数据块抽样"></a>数据块抽样</h4><p>Hive提供了另外一种按照百分比进行抽样的方式，这种是基于行数的，按照输入路径下的数据块百分比进行的抽样。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> stu <span class="keyword">tablesample</span>(<span class="number">0.1</span> <span class="keyword">percent</span>);</span></pre></td></tr></table></figure>

<p>提示：这种抽样方式不一定适用于所有的文件格式。另外，这种抽样的最小抽样单元是一个HDFS数据块。因此，如果表的数据大小小于普通的块的大小128M的话，那么将会返回所有行。</p>
<h3 id="行转列和列转行"><a href="#行转列和列转行" class="headerlink" title="行转列和列转行"></a>行转列和列转行</h3><h4 id="行转列"><a href="#行转列" class="headerlink" title="行转列"></a>行转列</h4><p>创建学生表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student_info(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">course <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入本地数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/data/student_info.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> student_info;</span></pre></td></tr></table></figure>

<p>查看表中数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> student_info;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">OK</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+--------------------+----------------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">| student_info.id  | student_info.name  | student_info.course  |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+--------------------+----------------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| 103              | zhangsan           | Java                 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| 103              | zhangsan           | SQL                  |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">| 105              | lisi               | Python               |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| 109              | wangwu             | Scala                |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">| 109              | wangwu             | Spark                |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+--------------------+----------------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">5 rows selected (0.742 seconds)</span></pre></td></tr></table></figure>

<p>将多行转为1行（行转列）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">id</span>),<span class="keyword">name</span>,<span class="keyword">concat_ws</span>(<span class="string">','</span>,collect_set(course)) <span class="keyword">as</span> courses</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> student_info </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 没有id列</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>,<span class="keyword">concat_ws</span>(<span class="string">','</span>,collect_set(course)) <span class="keyword">as</span> courses</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> student_info </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">INFO  : OK</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+-----------+--------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">| _c0  |   name    |   courses    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+-----------+--------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">| 105  | lisi      | Python       |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">| 109  | wangwu    | Scala,Spark  |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">| 103  | zhangsan  | Java,SQL     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+-----------+--------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">3 rows selected (35.758 seconds)</span></pre></td></tr></table></figure>



<h4 id="列转行"><a href="#列转行" class="headerlink" title="列转行"></a>列转行</h4><p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student_info2(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">courses <span class="keyword">string</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 加载数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/vinx/data/student_info2.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> student_info2;</span></pre></td></tr></table></figure>

<p>查看表数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> student_info2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-------------------+---------------------+------------------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| student_info2.id  | student_info2.name  | student_info2.courses  |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-------------------+---------------------+------------------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| 103               | zhangsan            | Java,SQL               |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| 105               | lisi                | Python                 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| 109               | wangwu              | Scala,Spark            |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-------------------+---------------------+------------------------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">3 rows selected (0.128 seconds)</span></pre></td></tr></table></figure>

<p>将1行转为多行（列转行）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,course </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> student_info2 a</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(<span class="keyword">split</span>(a.courses, <span class="string">','</span>)) b <span class="keyword">as</span> course;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+-----------+---------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">|  id  |   name    | course  |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+-----------+---------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">| 103  | zhangsan  | Java    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| 103  | zhangsan  | SQL     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">| 105  | lisi      | Python  |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">| 109  | wangwu    | Scala   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">| 109  | wangwu    | Spark   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+-----------+---------+--+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">5 rows selected (0.202 seconds)</span></pre></td></tr></table></figure>

<h4 id="关键函数释义"><a href="#关键函数释义" class="headerlink" title="关键函数释义"></a>关键函数释义</h4><p>使用<code>desc function extended split</code>可以查看split()函数的用法，行列互转的关键函数的官方释义如下：</p>
<ul>
<li><p><code>collect_set(x)</code> - returns a set of objects with duplicate elements eliminated.</p>
<p>返回一个不重合的set集合</p>
</li>
<li><p><code>concat_ws(separator, [string | array(string)]+)</code> - returns the concatenation of the strings separated by the separator.</p>
<p>返回以指定分隔符隔离的拼接起来的字符串</p>
</li>
<li><p><code>split(str, regex)</code> - splits str around occurances that match regex.</p>
<p>以指定分隔符切割字符串，并返回切割后的字符串数组</p>
</li>
<li><p><code>explode(a)</code> - separates the elements of array a into multiple rows, or the elements of a map into multiple rows and columns.</p>
<p>分割数组元素为多行，或分割map的元素为多行和多列</p>
</li>
<li><p><code>lateral view</code> - 侧视图配合<code>explode</code>，把单行数据拆解成多行，不加<code>lateral view</code>的UDTF(User-Defined Table-Generating Functions)只能提取单个字段拆分，并不能塞回原来的数据表中，加上<code>lateral view</code>就可以将拆分的单个字段数据与原始表数据关联上</p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">VinxC</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="/https:/vinxikk.github.io/2018/04/15/dw/hive-2/">https://vinxikk.github.io/2018/04/15/dw/hive-2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AE%A1%E7%90%86%E8%A1%A8%E5%92%8C%E5%A4%96%E9%83%A8%E8%A1%A8/">管理表和外部表</a><a class="post-meta__tags" href="/tags/%E5%88%86%E5%8C%BA%E8%A1%A8/">分区表</a><a class="post-meta__tags" href="/tags/%E5%88%86%E6%A1%B6%E8%A1%A8/">分桶表</a><a class="post-meta__tags" href="/tags/%E8%A1%8C%E5%88%97%E4%BA%92%E8%BD%AC/">行列互转</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/04/17/hive/hive-window-function/"><i class="fa fa-chevron-left">  </i><span>Hive窗口函数</span></a></div><div class="next-post pull-right"><a href="/2018/04/14/dw/hive-1/"><span>Hive基本概念&amp;Hive的部署&amp;Hive的基本命令</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By VinxC</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>