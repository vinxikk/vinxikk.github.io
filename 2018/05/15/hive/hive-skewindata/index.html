<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Hive的数据倾斜及性能调优"><meta name="keywords" content="数据倾斜"><meta name="author" content="VinxC"><meta name="copyright" content="VinxC"><title>Hive的数据倾斜及性能调优 | VinxC's blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据倾斜"><span class="toc-number">1.</span> <span class="toc-text">数据倾斜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常见问题"><span class="toc-number">2.</span> <span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-number">3.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#调参"><span class="toc-number">3.1.</span> <span class="toc-text">调参</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sort-Merge-Bucket-Join-SMB-Join"><span class="toc-number">3.2.</span> <span class="toc-text">Sort Merge Bucket Join (SMB Join)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Map-Join"><span class="toc-number">3.3.</span> <span class="toc-text">Map Join</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SMB-Map-Join"><span class="toc-number">3.4.</span> <span class="toc-text">SMB Map Join</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#嵌套Map-Join"><span class="toc-number">3.5.</span> <span class="toc-text">嵌套Map Join</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#where优化"><span class="toc-number">3.6.</span> <span class="toc-text">where优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#union-all优化"><span class="toc-number">3.7.</span> <span class="toc-text">union all优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#count-distinct优化"><span class="toc-number">3.8.</span> <span class="toc-text">count distinct优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#空值特殊处理"><span class="toc-number">3.9.</span> <span class="toc-text">空值特殊处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#类型转换"><span class="toc-number">3.10.</span> <span class="toc-text">类型转换</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://vinxikk.github.io/img/avatar.png"></div><div class="author-info__name text-center">VinxC</div><div class="author-info__description text-center">A Bigdata Developer</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">66</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">86</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">14</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com" target="_blank" rel="noopener">Molunerfinn</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">VinxC's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Hive的数据倾斜及性能调优</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Hive/">Hive</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.1k</span><span class="post-meta__separator">|</span><span>Reading time: 7 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="数据倾斜"><a href="#数据倾斜" class="headerlink" title="数据倾斜"></a>数据倾斜</h3><p>数据倾斜是指，MR程序执行时，reduce节点大部分执行完毕，但是有一个或者几个reduce节点运行很慢，导致整个程序的处理时间很长。这是因为某一个key的条数比其他key多很多（有时是百倍或者千倍之多），这条key所在的reduce节点所处理的数据量比其他节点就大很多，从而导致某几个节点迟迟运行不完。</p>
<p>表现：</p>
<p>任务进度长时间维持在99%（或者100%），查看任务监控页面，发现只有少量（1个或几个）reduce子任务未完成。单一reduce的记录数与平均记录数差异过大，通常可能达到3倍甚至更多。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><table>
<thead>
<tr>
<th>类型</th>
<th>keyword</th>
<th>情形</th>
<th>后果</th>
<th>解决方法</th>
</tr>
</thead>
<tbody><tr>
<td>数据倾斜</td>
<td>join</td>
<td>其中一个表是小表（1000条以下记录或1G容量以下）</td>
<td>分发到某几个reduce上的数据远高于平均值</td>
<td>SMB Join,  Map Join, SMB Map Join</td>
</tr>
<tr>
<td>数据倾斜</td>
<td></td>
<td>大表与大表join，但是关联值0或null过多</td>
<td>空值会由一个reduce处理，非常慢</td>
<td>SMB Join, 空值特殊处理, 调参(skewjoin)</td>
</tr>
<tr>
<td>数据倾斜</td>
<td></td>
<td>小表不小不大</td>
<td>-</td>
<td>嵌套Map Join</td>
</tr>
<tr>
<td>数据倾斜</td>
<td></td>
<td>不同数据类型关联</td>
<td>默认的Hash操作会按int型的id来进行分配，所有string类型id的记录都分配到一个reducer中</td>
<td>类型转换</td>
</tr>
<tr>
<td>数据倾斜</td>
<td>group by</td>
<td>某些维度值数据过多</td>
<td>处理某值的reduce耗时</td>
<td>调参(skewindata)</td>
</tr>
<tr>
<td>数据倾斜</td>
<td>count distinct</td>
<td>某些值过多</td>
<td>处理某值的reduce耗时</td>
<td>count distinct优化</td>
</tr>
<tr>
<td>数据量大</td>
<td>on … where …</td>
<td>过滤在where条件</td>
<td>大数据量join</td>
<td>where优化</td>
</tr>
<tr>
<td>Job数多</td>
<td>union all</td>
<td>union属于嵌套查询</td>
<td>生成过多的job</td>
<td>union all优化</td>
</tr>
</tbody></table>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="调参"><a href="#调参" class="headerlink" title="调参"></a>调参</h4><p>对于group by引起的倾斜，设置下面的参数：</p>
<p><code>set hive.map.aggr = true</code></p>
<p><code>set hive.groupby.skewindata=true</code></p>
<p>有数据倾斜的时候进行负载均衡，当选项设定为true，生成的查询计划会有两个MR Job。</p>
<p>第一个MR Job中，Map的输出结果集合会随机分布到Reduce中，每个Reduce做部分聚合操作，并输出结果，这样处理的结果是相同的Group By Key有可能被分发到不同的Reduce中，从而达到负载均衡的目的。</p>
<p>第二个MR Job再根据预处理的数据结果按照Group By Key分布到Reduce中（这个过程可以保证相同的Group By Key被分布到同一个Reduce中），最后完成最终的聚合操作。</p>
<p>skew join优化：</p>
<p><code>set hive.optimize.skewjoin = true;</code></p>
<p>skew join，其原理是把这种user_id=0的特殊值先不在Reduce端计算掉，而是先写入hdfs，然后启动一轮Map join专门做这个特殊值的计算，期望能提高计算这部分值的处理速度。还有要告诉Hive如何判断特殊值，根据<code>hive.skewjoin.key</code>设置的数量Hive可以知道，比如默认值是100000，那么超过100000条记录的值就是特殊值。</p>
<h4 id="Sort-Merge-Bucket-Join-SMB-Join"><a href="#Sort-Merge-Bucket-Join-SMB-Join" class="headerlink" title="Sort Merge Bucket Join (SMB Join)"></a>Sort Merge Bucket Join (SMB Join)</h4><p>Hive桶：</p>
<p>对于每一个表（table）或者分区，Hive可以进一步组织成桶，也就是说桶是更为细粒度的数据范围划分。Hive采用对列值哈希，然后除以桶的个数求余的方式决定该条记录存放在哪个桶当中。</p>
<p>SMB Join:</p>
<ol>
<li>解决大表与小表间的join问题。小表的number_buckets必须是大表的倍数。</li>
<li>解决大表与大表间的join问题。这一优化方法并不一定要求两个表必须桶的个数相同，两个表的桶个数是倍数关系也可以。</li>
</ol>
<p><img src="https://vinxikk.github.io/img/hive/hive-smb-join.png" alt="SMB Join"></p>
<p>例子：</p>
<p><img src="https://vinxikk.github.io/img/hive/hive-smb-join-example.png" alt="SMB Join例子"></p>
<h4 id="Map-Join"><a href="#Map-Join" class="headerlink" title="Map Join"></a>Map Join</h4><p>对于大小表关联查询产生的数据倾斜，一般的做法是使用Map Join将其中做连接的小表（全量数据）分发到所有map task端进行join，从而避免reduce task，前提要求是内存足以装下该全量数据。</p>
<p>以大表a和小表b为例，所有的map task节点都装载小表b的所有数据，然后大表a的一个数据块数据比如a1去跟b全量数据做连接，就省去了reduce做汇总的过程。</p>
<p>所以相对来说，在内存允许的条件下使用map join比直接使用MapReduce效率还高些，当然这只限于做join查询的时候。</p>
<p>所有的工作都在Map端进行计算。首先小表的Map阶段它会将自己转化成MapReduce Local Task，然后从HDFS取小表的所有数据，将自己转化成Hashtable file并压缩打包放入DistributedCache里面。</p>
<p><code>hive.auto.convert.join=true ;</code>  设置Map Join优化自动开启 </p>
<p><code>hive.smalltable.filesize=25000000L;</code>  参数控制（默认25M），当小表超过这个大小，hive会默认转化成common join。另一种是手动判断<code>/*+mapjoin(map_table)*/</code>。</p>
<p>认为开启Map Join：</p>
<p><code>select /* +mapjoin(b) */ a.id aid,name,age from a join b on a.id = b.id;</code></p>
<p>因为加了<code>/* +mapjoin(b) */</code>这一段代码，执行的时候就会将b表读入内存中，但是要求b表必须是小表，数据量不能太大。</p>
<h4 id="SMB-Map-Join"><a href="#SMB-Map-Join" class="headerlink" title="SMB Map Join"></a>SMB Map Join</h4><p>两个表关联键为imei，需要按imei分桶并且排序，小表（lxw_test）分桶数是大表（lxw_test1）的倍数。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> lxw_test(imei <span class="keyword">string</span>,sndaid <span class="keyword">string</span>,data_time <span class="keyword">string</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">CLUSTERED <span class="keyword">BY</span>(imei) SORTED <span class="keyword">BY</span>(imei) <span class="keyword">INTO</span> <span class="number">10</span> BUCKETS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> lxw_test1(imei <span class="keyword">string</span>,sndaid <span class="keyword">string</span>,data_time <span class="keyword">string</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">CLUSTERED <span class="keyword">BY</span>(imei) SORTED <span class="keyword">BY</span>(imei) <span class="keyword">INTO</span> <span class="number">5</span> BUCKETS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.enforce.bucketing = <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--插入数据前需要打开该选项</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.optimize.bucketmapjoin = <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.optimize.bucketmapjoin.sortedmerge = <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.input.format=org.apache.hadoop.hive.ql.io.BucketizedHiveInputFormat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--join时需要打开的参数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+ mapjoin(b) */</span> <span class="keyword">count</span>(<span class="number">1</span>) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxw_test1 a </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">join</span> lxw_test b </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">on</span> a.imei = b.imei</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--包括insert数据，差不多10分钟左右；</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--如果这两个表做普通的join, 耗时1个多小时，没跑完，kill掉了。</span></span></pre></td></tr></table></figure>

<h4 id="嵌套Map-Join"><a href="#嵌套Map-Join" class="headerlink" title="嵌套Map Join"></a>嵌套Map Join</h4><p>小表不大不小，怎么用map join解决倾斜问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+mapjoin(x)*/</span>* <span class="keyword">from</span> <span class="keyword">log</span> a</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> (</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">select</span>  <span class="comment">/*+mapjoin(c)*/</span>d.*</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">from</span> ( <span class="keyword">select</span> <span class="keyword">distinct</span> user_id <span class="keyword">from</span> <span class="keyword">log</span> ) c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">join</span> <span class="keyword">users</span> d</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">on</span> c.user_id = d.user_id</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    ) x</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">on</span> a.user_id = b.user_id;</span></pre></td></tr></table></figure>

<h4 id="where优化"><a href="#where优化" class="headerlink" title="where优化"></a>where优化</h4><p>WHERE条件放置在ON条件中，以达到两表做join的时候，数据量相对变小的效果。</p>
<h4 id="union-all优化"><a href="#union-all优化" class="headerlink" title="union all优化"></a>union all优化</h4><p>union all优化还不完善，嵌套查询时会生成过多的job。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--Before</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> * <span class="keyword">from</span> t1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">union</span> <span class="keyword">all</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">select</span> * <span class="keyword">from</span> t4</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">union</span> <span class="keyword">all</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">select</span> * <span class="keyword">from</span> t2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">join</span> t3</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">on</span> t2.id = t3.id</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">     ) x</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c1,c2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--After</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--先join生成临时表，后union all。原来4个jobs，改进后变成2个jobs。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> t5</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">join</span> t3</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">on</span> t2.id = t3.id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> (t1 <span class="keyword">union</span> <span class="keyword">all</span> t4 <span class="keyword">union</span> <span class="keyword">all</span> t5);</span></pre></td></tr></table></figure>

<h4 id="count-distinct优化"><a href="#count-distinct优化" class="headerlink" title="count distinct优化"></a>count distinct优化</h4><p>在Hive中应小心使用count distinct，因为很可能出现性能问题。</p>
<p>因为要去重，hive会把map阶段的输出全部分配到一个reduce task上，此时很容易发生性能问题，我们可以先group by，再count，减少distinct的使用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/*改写前*/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">count</span>(<span class="keyword">distinct</span> course) <span class="keyword">as</span> course_count</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> student </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/*改写后*/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.id,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> course_count</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> (</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>,course </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">from</span> student</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">) a</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 或者</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.id,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> course_count </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> (</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> student </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>,course</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">) a </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.id;</span></pre></td></tr></table></figure>

<h4 id="空值特殊处理"><a href="#空值特殊处理" class="headerlink" title="空值特殊处理"></a>空值特殊处理</h4><p>在日志中，常会有字段值丢失的问题，比如日志中的user_id，如果取其中的user_id和用户表中的user_id相关联，就会碰到数据倾斜的问题。</p>
<p>方法1，user_id为空的不参与关联：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">log</span> a </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">join</span> <span class="keyword">user</span> b </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">on</span> a.user_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> a.user_id = b.user_id </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">log</span> c </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">where</span> c.user_id <span class="keyword">is</span> <span class="literal">null</span>;</span></pre></td></tr></table></figure>

<p>方法2，把空值的key变成一个字符串加上随机数，把倾斜的数据分到不同的reduce上：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">log</span> a </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> <span class="keyword">user</span> b </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">on</span> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> a.user_id <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="keyword">concat</span>(<span class="string">'null_'</span>,<span class="keyword">rand</span>()) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> a.user_id <span class="keyword">end</span> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">= b.user_id;</span></pre></td></tr></table></figure>

<p>方法2比方法1效率更好，不但IO少了，而且作业数也少了。</p>
<p>方法1中，log表读了两次，job数肯定是2，而方法2的job数是1.</p>
<p>方法2使本身为null的所有记录不会拥挤在同一个reduce task中，加上随机字符串值，会分散到过个reduce task中，由于null值关联不上，处理后并不影响最终结果。</p>
<h4 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h4><p>场景：用户表中user_id字段为int，log表中user_id字段既有string类型也有int类型。当按照user_id进行两个表的join操作时，默认的hash操作会按int型的id来进行分配，这样会导致所有string类型id的记录都分配到一个Reduce中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> a</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> <span class="keyword">logs</span> b</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">on</span> a.usr_id = <span class="keyword">cast</span>(b.user_id <span class="keyword">as</span> <span class="keyword">string</span>)</span></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">VinxC</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="/https:/vinxikk.github.io/2018/05/15/hive/hive-skewindata/">https://vinxikk.github.io/2018/05/15/hive/hive-skewindata/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C/">数据倾斜</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/05/16/hive/hive-compress/"><i class="fa fa-chevron-left">  </i><span>Hive的压缩格式</span></a></div><div class="next-post pull-right"><a href="/2018/05/14/hive/hive-bucket/"><span>Hive的数据分桶及使用场景</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By VinxC</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>